<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yunfeng.erp.dao.StockRecordDao">

    <resultMap id="stockRecordResultMap" type="com.yunfeng.erp.model.StockRecord">
        <id property="recordNo" column="record_no" />
        <result property="totalAmount" column="total_amount" />
        <result property="createTime" column="create_time" />
        <result property="remark" column="remark" />
        <association property="shop" javaType="com.yunfeng.erp.model.Shop">
            <id property="id" column="shop_id"/>
            <result property="name" column="name"/>
        </association>
        <association property="createUser" javaType="com.yunfeng.erp.model.User">
            <id property="id" column="user_id"/>
            <result property="username" column="user_name"/>
        </association>
        <association property="supplier" javaType="com.yunfeng.erp.model.Supplier">
            <id property="id" column="supplier_id"/>
            <result property="name" column="supplier_name"/>
        </association>
    </resultMap>

    <resultMap id="stockRecordCollectionItemsResultMap" type="com.yunfeng.erp.model.StockRecord">
        <id property="recordNo" column="record_no" />
        <result property="totalAmount" column="total_amount" />
        <result property="createTime" column="create_time" />
        <result property="remark" column="remark" />
        <association property="shop" javaType="com.yunfeng.erp.model.Shop">
            <id property="id" column="shop_id"/>
            <result property="name" column="name"/>
        </association>
        <association property="createUser" javaType="com.yunfeng.erp.model.User">
            <id property="id" column="user_id"/>
            <result property="username" column="user_name"/>
        </association>
        <association property="supplier" javaType="com.yunfeng.erp.model.Supplier">
            <id property="id" column="supplier_id"/>
            <result property="name" column="supplier_name"/>
        </association>
        <collection property="items" ofType="com.yunfeng.erp.model.StockRecordItem">
            <id property="id" column="goods_id" />
            <result property="recordNo" column="record_no" />
            <result property="buyQuantity" column="buy_quantity" />
            <result property="presentQuantity" column="present_quantity" />
            <association property="goods" javaType="com.yunfeng.erp.model.Goods">
                <id property="id" column="goods_id"/>
                <result property="name" column="goods_name"/>
                <result property="barcode" column="barcode"/>
                <result property="latestPurchasePrice" column="latest_purchase_price"/>
                <association property="brand" javaType="com.yunfeng.erp.common.KeyValue">
                    <id property="key" column="brand_id" javaType="int"/>
                    <result property="value" column="brand_name"/>
                </association>
                <association property="unit" javaType="com.yunfeng.erp.common.KeyValue">
                    <id property="key" column="unit_id" javaType="int"/>
                    <result property="value" column="unit_name"/>
                </association>
            </association>
        </collection>
    </resultMap>

    <resultMap id="stockRecordItemResultMap" type="com.yunfeng.erp.model.StockRecordItem">
        <id property="id" column="goods_id" />
        <result property="recordNo" column="record_no" />
        <result property="buyQuantity" column="buy_quantity" />
        <result property="presentQuantity" column="present_quantity" />
        <association property="goods" javaType="com.yunfeng.erp.model.Goods">
            <id property="id" column="goods_id"/>
            <result property="name" column="goods_name"/>
            <result property="barcode" column="barcode"/>
            <result property="latestPurchasePrice" column="latest_purchase_price"/>
        </association>
    </resultMap>

    <sql id="selectAllColumns">
        SELECT er.record_no,er.total_amount,er.supplier_id,er.create_time,er.remark,es.id AS shop_id,es.name,
            er.create_user_id AS user_id,eu.user_name,esl.name AS supplier_name
        FROM erp_stock_record er
        LEFT JOIN erp_shop es ON er.shop_id = es.id
        LEFT JOIN erp_user eu ON er.create_user_id = eu.id
        LEFT JOIN erp_supplier esl ON er.supplier_id = esl.id
    </sql>

    <sql id="selectCollectionItemsAllColumns">
        SELECT esr.record_no,esr.total_amount,esr.supplier_id,esr.create_time,esr.remark,esr.shop_id AS shop_id,ep.name,
            esr.create_user_id AS user_id,eu.user_name,
            esi.record_no,esi.buy_quantity,esi.buy_price AS latest_purchase_price,esi.present_quantity
            ,esi.goods_id AS goods_id,eg.`name` AS goods_name,eg.barcode,eg.brand_id,egb.name AS brand_name,
            eg.unit_id,egu.name AS unit_name,esl.name AS supplier_name
        FROM erp_stock_record esr
            LEFT JOIN erp_stock_record_item esi ON esr.record_no = esi.record_no
            LEFT JOIN erp_shop ep ON esr.shop_id = ep.id
            LEFT JOIN erp_user eu ON esr.create_user_id = eu.id
            LEFT JOIN erp_goods eg ON esi.goods_id = eg.id
            LEFT JOIN erp_goods_brand egb ON eg.brand_id = egb.id
            LEFT JOIN erp_goods_unit egu ON eg.unit_id = egu.id
            LEFT JOIN erp_supplier esl ON esr.supplier_id = esl.id
    </sql>

    <sql id="selectItemAllColumns">
        SELECT esi.record_no,esi.buy_quantity,esi.buy_price AS latest_purchase_price,esi.present_quantity
            ,eg.id AS goods_id,eg.`name` AS goods_name,eg.barcode FROM erp_stock_record_item esi
            LEFT JOIN erp_goods eg ON esi.goods_id = eg.id
    </sql>

    <insert id="insertStockRecord" parameterType="com.yunfeng.erp.model.StockRecord"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO erp_stock_record(record_no,total_amount,create_time,remark,supplier_id,shop_id,create_user_id)
        VALUES (#{recordNo},#{totalAmount},#{createTime},#{remark},#{supplier.id},#{shop.id},#{createUser.id});
    </insert>

    <insert id="batchInsertStockRecordItems" parameterType="com.yunfeng.erp.model.StockRecordItem"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO erp_stock_record_item(record_no,goods_id,buy_price,buy_quantity,present_quantity)
        VALUES
            <foreach collection="items" item="item" separator=",">
              (#{item.recordNo},#{item.goods.id},#{item.goods.latestPurchasePrice},#{item.buyQuantity},#{item.presentQuantity})
            </foreach>
    </insert>


    <select id="queryStockRecordsBy" resultMap="stockRecordResultMap">
        <include refid="selectAllColumns" />
        <where>
            <if test="query.shopId != null">er.shop_id = #{query.shopId}</if>
            <if test="query.recordNo != null and query.recordNo != ''">AND er.record_no = #{query.recordNo}</if>
            <if test="query.startTime != null">AND er.create_time >= #{query.earliestStartTime}</if>
            <if test="query.endTime != null"><![CDATA[AND er.create_time <= #{query.latestEndTime}]]></if>
        </where>
        ORDER BY er.create_time DESC
    </select>

    <select id="queryStockRecordByNo" resultMap="stockRecordCollectionItemsResultMap">
        <include refid="selectCollectionItemsAllColumns" />
        WHERE esr.record_no = #{recordNo}
        ORDER BY eg.name
    </select>

    <select id="queryStockRecordItemsBy" resultMap="stockRecordItemResultMap">
        <include refid="selectItemAllColumns" />
        WHERE esi.record_no = #{recordNo}
        ORDER BY eg.name
    </select>

</mapper>